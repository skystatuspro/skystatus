# Flying Blue Change Monitor
# Checks if official Flying Blue pages have changed
# Creates an issue when changes are detected so guide content can be reviewed

name: ğŸ” Monitor Flying Blue

on:
  schedule:
    # Daily at 8 AM Amsterdam time
    - cron: '0 7 * * *'
  workflow_dispatch:

jobs:
  monitor:
    name: Check for Flying Blue changes
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create cache directory
        run: mkdir -p .fb-cache

      - name: Check Flying Blue pages for changes
        id: check
        run: |
          # Pages to monitor (key official sources referenced in guides)
          # UITGEBREID met extra pagina's die in de guides worden gelinkt
          PAGES=(
            # Core status & XP pages
            "https://www.flyingblue.com/en/programme/more-info/status|Flying Blue Status & XP"
            "https://www.klm.com/information/flying-blue/membership-levels|KLM Membership Levels"
            "https://www.flyingblue.com/en/landing-page/informative/ultimate-information|Ultimate Status Info"
            "https://www.flyingblue.com/en/programme/more-info/tier-benefits|Tier Benefits"
            
            # Miles acquisition
            "https://www.flyingblue.com/en/flyingblue-extra|Flying Blue Extra"
            "https://www.flyingblue.com/en/mileshub/buy|Miles Hub Buy"
            "https://www.flyingblue.com/en/mileshub/subscription|Miles Subscription"
            "https://www.flyingblue.com/en/news/subscribe-to-miles|Subscribe to Miles Info"
            "https://www.flyingblue.com/en/mileshub/convert|Transfer Partners"
            
            # Miles spending
            "https://www.flyingblue.com/en/spend/flights/rewards|Award Flights"
            "https://www.flyingblue.com/en/flights/promo-rewards|Promo Rewards"
            
            # Rules & news
            "https://www.flyingblue.com/en/news/surplus-xp-capping|XP Rollover Capping"
            "https://www.flyingblue.com/en/news/extend-miles|Extend Miles"
          )
          
          CHANGES=""
          CHANGED_COUNT=0
          
          for entry in "${PAGES[@]}"; do
            URL="${entry%%|*}"
            NAME="${entry##*|}"
            HASH_FILE=".fb-cache/$(echo "$URL" | md5sum | cut -d' ' -f1).hash"
            
            echo "Checking: $NAME"
            echo "  URL: $URL"
            
            # Fetch page and create hash (strip dynamic content)
            NEW_HASH=$(curl -sL --max-time 30 "$URL" 2>/dev/null | \
              grep -v -E 'session|csrf|timestamp|nonce|__cf|cloudflare|gtm|analytics' | \
              sha256sum | cut -d' ' -f1)
            
            if [ -z "$NEW_HASH" ]; then
              echo "  âš ï¸ Could not fetch page"
              continue
            fi
            
            if [ -f "$HASH_FILE" ]; then
              OLD_HASH=$(cat "$HASH_FILE")
              if [ "$NEW_HASH" != "$OLD_HASH" ]; then
                echo "  ğŸ”„ CHANGED!"
                CHANGES="${CHANGES}\n- **${NAME}**: ${URL}"
                CHANGED_COUNT=$((CHANGED_COUNT + 1))
              else
                echo "  âœ“ No change"
              fi
            else
              echo "  ğŸ“ First check (baseline)"
            fi
            
            # Save new hash
            echo "$NEW_HASH" > "$HASH_FILE"
          done
          
          echo ""
          echo "Summary: $CHANGED_COUNT page(s) changed"
          
          if [ $CHANGED_COUNT -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            # Escape newlines for GitHub Actions
            CHANGES_ESCAPED=$(echo -e "$CHANGES" | sed ':a;N;$!ba;s/\n/\\n/g')
            echo "changed_pages=$CHANGES_ESCAPED" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit updated hashes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .fb-cache/
          git diff --staged --quiet || git commit -m "chore: update Flying Blue page hashes [skip ci]"
          git push || echo "Nothing to push"

      - name: Create issue on changes
        if: steps.check.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const changedPages = `${{ steps.check.outputs.changed_pages }}`.replace(/\\n/g, '\n');
            const today = new Date().toISOString().split('T')[0];
            
            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'flying-blue-update'
            });
            
            const body = `## âš ï¸ Flying Blue Page Changes Detected

**Date:** ${today}

The following official Flying Blue pages have changed:

${changedPages}

### Action Required
1. Visit each changed page and review the updates
2. Check if any guide content needs to be updated:
   - XP requirements or earning rates
   - Status benefits
   - Pricing information
   - Program rules
   - Rollover mechanics
3. Update relevant guide pages if needed
4. Run a build to update "Last verified" dates
5. Close this issue when reviewed

### Potentially Affected Guides
- \`/guide/what-is-flying-blue-xp\`
- \`/guide/flying-blue-status-levels\`
- \`/guide/flying-blue-gold-status\`
- \`/guide/flying-blue-platinum-status\`
- \`/guide/flying-blue-ultimate-status\`
- \`/guide/flying-blue-uxp-explained\`
- \`/guide/flying-blue-xp-rollover\`
- \`/guide/flying-blue-subscription\`
- \`/guide/should-you-buy-flying-blue-miles\`
- \`/guide/flying-blue-cost-per-mile\`
- \`/guide/flying-blue-miles-value\`
`;
            
            if (issues.data.length > 0) {
              // Comment on existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `## ğŸ”„ New Changes Detected\n\n${body}`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `âš ï¸ Flying Blue pages changed - review guides (${today})`,
                body: body,
                labels: ['flying-blue-update', 'content-review', 'automated']
              });
            }
