# Flying Blue Change Monitor
# Checks if official Flying Blue pages have changed
# Creates an issue when changes are detected so guide content can be reviewed

name: Monitor Flying Blue

on:
  schedule:
    # Daily at 8 AM Amsterdam time
    - cron: '0 7 * * *'
  workflow_dispatch:

jobs:
  monitor:
    name: Check for Flying Blue changes
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create cache directory
        run: mkdir -p .fb-cache

      - name: Check Flying Blue pages for changes
        id: check
        run: |
          PAGES=(
            "https://www.flyingblue.com/en/programme/more-info/status|Flying Blue Status & XP"
            "https://www.klm.com/information/flying-blue/membership-levels|KLM Membership Levels"
            "https://wwws.airfrance.fr/en/information/flyingblue/statuts-flying-blue|Air France Flying Blue Levels"
            "https://www.flyingblue.com/en/landing-page/informative/ultimate-information|Ultimate Status Info"
            "https://www.flyingblue.com/en/programme/more-info/tier-benefits|Tier Benefits"
            "https://www.flyingblue.com/en/flyingblue-extra|Flying Blue Extra"
            "https://www.flyingblue.com/en/mileshub/buy|Miles Hub Buy"
            "https://www.flyingblue.com/en/mileshub/subscription|Miles Subscription"
            "https://www.flyingblue.com/en/news/subscribe-to-miles|Subscribe to Miles Info"
            "https://www.flyingblue.com/en/mileshub/convert|Transfer Partners"
            "https://www.flyingblue.com/en/spend/flights/rewards|Award Flights"
            "https://www.flyingblue.com/en/flights/promo-rewards|Promo Rewards"
            "https://www.flyingblue.com/en/news/surplus-xp-capping|XP Rollover Capping"
            "https://www.flyingblue.com/en/news/extend-miles|Extend Miles"
          )
          
          CHANGED=""
          
          for entry in "${PAGES[@]}"; do
            URL="${entry%%|*}"
            NAME="${entry##*|}"
            HASH_FILE=".fb-cache/$(echo "$URL" | md5sum | cut -d' ' -f1).txt"
            
            CURRENT_HASH=$(curl -sL "$URL" 2>/dev/null | grep -v 'data-\|timestamp\|csrf\|nonce' | md5sum | cut -d' ' -f1)
            
            if [ -f "$HASH_FILE" ]; then
              STORED_HASH=$(cat "$HASH_FILE")
              if [ "$CURRENT_HASH" != "$STORED_HASH" ]; then
                CHANGED="${CHANGED}- **${NAME}**: ${URL}\n"
                echo "$CURRENT_HASH" > "$HASH_FILE"
              fi
            else
              echo "$CURRENT_HASH" > "$HASH_FILE"
            fi
          done
          
          if [ -n "$CHANGED" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_pages<<EOF" >> $GITHUB_OUTPUT
            echo -e "$CHANGED" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit updated hashes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .fb-cache/
          git diff --staged --quiet || git commit -m "chore: update Flying Blue page hashes [skip ci]"
          git push || echo "Nothing to push"

      - name: Create issue on changes
        if: steps.check.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const changedPages = process.env.CHANGED_PAGES.replace(/\\n/g, '\n');
            const today = new Date().toISOString().split('T')[0];
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'flying-blue-update'
            });
            
            const body = [
              '## Flying Blue Page Changes Detected',
              '',
              '**Date:** ' + today,
              '',
              'The following official Flying Blue pages have changed:',
              '',
              changedPages,
              '',
              '### Action Required',
              '1. Visit each changed page and review the updates',
              '2. Check if any guide content needs to be updated',
              '3. Update relevant guide pages if needed',
              '4. Run a build to update "Last verified" dates',
              '5. Close this issue when reviewed'
            ].join('\n');
            
            if (issues.data.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Flying Blue pages changed - review guides',
                body: body,
                labels: ['flying-blue-update']
              });
            }
        env:
          CHANGED_PAGES: ${{ steps.check.outputs.changed_pages }}
