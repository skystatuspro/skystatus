# Uptime Monitor
# Checks if skystatus.pro is reachable every 30 minutes
# Creates an issue if the site is down

name: Uptime Monitor

on:
  schedule:
    # Every 30 minutes
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  uptime-check:
    name: Check if site is up
    runs-on: ubuntu-latest
    
    steps:
      - name: Check skystatus.pro
        id: check
        run: |
          URLS=(
            "https://skystatus.pro"
            "https://skystatus.pro/guide"
            "https://skystatus.pro/faq"
          )
          
          FAILED=""
          
          for url in "${URLS[@]}"; do
            echo "Checking $url..."
            
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$url" || echo "000")
            
            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 400 ]; then
              echo "  OK $url - HTTP $HTTP_CODE"
            else
              echo "  FAIL $url - HTTP $HTTP_CODE"
              FAILED="${FAILED}\n- $url (HTTP $HTTP_CODE)"
            fi
          done
          
          if [ -n "$FAILED" ]; then
            echo "is_down=true" >> $GITHUB_OUTPUT
            echo "failed_urls=$FAILED" >> $GITHUB_OUTPUT
          else
            echo "is_down=false" >> $GITHUB_OUTPUT
            echo "All endpoints responding correctly"
          fi

      - name: Create or update issue if down
        if: steps.check.outputs.is_down == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const failedUrls = process.env.FAILED_URLS.replace(/\\n/g, '\n');
            const now = new Date().toISOString();
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'downtime'
            });
            
            const body = [
              '## Site Down Alert',
              '',
              '**Detected:** ' + now,
              '',
              'The following URLs are not responding correctly:',
              failedUrls,
              '',
              '### Suggested Actions',
              '1. Check Vercel Dashboard for deployment status',
              '2. Check Supabase Dashboard for database status',
              '3. Try accessing the site manually',
              '4. Check DNS settings if all endpoints fail',
              '',
              'This issue will auto-close when the site is back up.'
            ].join('\n');
            
            if (issues.data.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: '### Still down at ' + now + '\n' + failedUrls
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'SkyStatus Pro is down!',
                body: body,
                labels: ['downtime', 'urgent', 'automated']
              });
            }
        env:
          FAILED_URLS: ${{ steps.check.outputs.failed_urls }}

      - name: Close issue if back up
        if: steps.check.outputs.is_down == 'false'
        uses: actions/github-script@v8
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'downtime'
            });
            
            const now = new Date().toISOString();
            
            for (const issue of issues.data) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: '### Site is back up!\n\nRecovered at ' + now
              });
              
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }
